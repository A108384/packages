name       : miopen
version    : 6.0.0
release    : 3
source     :
    # tag: rocm-6.0.0
    - git|https://github.com/ROCm/MIOpen.git : f34a90f7699e4af0e021ff0bf4111b1c407bdec1
homepage   : https://github.com/ROCmSoftwarePlatform/MIOpen
license    : MIT
component  : programming.library
summary    : AMD's Machine Intelligence Library
description: |
    MIOpen is AMD's library for high performance machine learning primitives.
# clang      : yes
networking : yes
builddeps  :
    - pkgconfig(bzip2)
    - pkgconfig(eigen3)
    - pkgconfig(nlohmann_json)
    - pkgconfig(sqlite3)
    - pkgconfig(libzstd)
    # - git-lfs
    - half
    - frugally-deep
    - libboost-devel
    - composable-kernel
    - rocblas-devel
    - rocm-cmake
    - rocm-hip
    - rocmlir
    - roctracer-devel
    # Deprecated by upstream
    # - miopengemm-devel
debug      : no
environment: |
    unset CFLAGS CXXFLAGS LDFLAGS

    export ROCM_PATH=/usr
    export HIP_CLANG_PATH=/usr/lib64/llvm-rocm/bin
    export DEVICE_LIB_PATH=/usr/lib64/amdgcn/bitcode
    export CMAKE_PREFIX_PATH=/usr/lib64/llvm-rocm
    export CMAKE_MODULE_PATH=/usr/lib64/llvm-rocm/lib64/cmake/llvm
setup      : |
    # Git LFS JUST DOESN'T WORK!!!!
    # git lfs fetch origin rocm-6.0.0 --all
    # git-lfs checkout
    for arch in gfx90a gfx900 gfx906 gfx908 gfx1030; do
        curl -o src/kernels/$arch.kdb.bz2 -L https://github.com/ROCm/MIOpen/raw/f34a90f7699e4af0e021ff0bf4111b1c407bdec1/src/kernels/$arch.kdb.bz2
    done

    sed -i "s|enable_testing()||" CMakeLists.txt
    sed -i "s|add_subdirectory(doc)||" CMakeLists.txt
    sed -i "s|add_subdirectory(test)||" CMakeLists.txt
    sed -i "s|add_subdirectory(speedtests)||" CMakeLists.txt
    sed -i 's|/opt/rocm/llvm|/usr/lib64/llvm-rocm|g' CMakeLists.txt
    sed -i 's|/opt/rocm|/usr|g' CMakeLists.txt

    %patch -p1 -i $pkgfiles/remove-clang-tidy-checks.diff

    %cmake_ninja -L \
      -DCMAKE_BUILD_TYPE="Release" \
      -DCMAKE_C_COMPILER=hipcc \
      -DCMAKE_CXX_COMPILER=hipcc \
      -DCMAKE_INSTALL_LIBDIR=lib%LIBSUFFIX% \
      -DROCM_SYMLINK_LIBS=OFF \
      -DBoost_USE_STATIC_LIBS=OFF \
      -DMIOPEN_TEST_ALL=OFF \
      -DMIOPEN_USE_COMGR=ON \
      -DMIOPEN_BACKEND=HIP \
      -DMIOPEN_AMDGCN_ASSEMBLER_PATH=$HIP_CLANG_PATH \
      -DMIOPEN_USE_COMPOSABLEKERNEL=ON \
      -DMIOPEN_USE_MIOPENGEMM=OFF \
      -DMIOPEN_USE_MLIR=ON \
      -DMIOPEN_USE_MIOPENTENSILE=OFF \
      -DMIOPEN_USE_ROCBLAS=ON \
      -DGPU_TARGETS="%AMDGPUTARGETS%" \
      -DAMDGPU_TARGETS="%AMDGPUTARGETS%"
build      : |
    %ninja_build
install    : |
    %ninja_install
