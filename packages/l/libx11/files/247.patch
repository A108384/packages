From 6f58bec8528ab121d8673a03bbf0570428d9e367 Mon Sep 17 00:00:00 2001
From: Weng Xuetian <wengxt@gmail.com>
Date: Fri, 29 Mar 2024 09:45:09 -0700
Subject: [PATCH 1/2] Revert "imDefLkup: Commit first info in XimCommitInfo"

This reverts commit 041b5291f0956c5cda5054be2981c0d02b009a4c.
---
 modules/im/ximcp/imDefLkup.c | 60 +++++++-----------------------------
 1 file changed, 11 insertions(+), 49 deletions(-)

diff --git a/modules/im/ximcp/imDefLkup.c b/modules/im/ximcp/imDefLkup.c
index 6ffe6f48..5192e8c1 100644
--- a/modules/im/ximcp/imDefLkup.c
+++ b/modules/im/ximcp/imDefLkup.c
@@ -640,47 +640,22 @@ _XimRegCommitInfo(
 }
 
 static void
-_XimUnregRealCommitInfo(
-    Xic			ic,
-    Bool		reverse)
+_XimUnregCommitInfo(
+    Xic			ic)
 {
     XimCommitInfo	info;
-    XimCommitInfo	prev_info = NULL;
 
-    info = ic->private.proto.commit_info;
-    while (reverse && info) {
-	if (!info->next)
-	    break;
-	prev_info = info;
-	info = info->next;
-    }
-    if (!info)
+    if (!(info = ic->private.proto.commit_info))
 	return;
 
+
     Xfree(info->string);
     Xfree(info->keysym);
-    if (prev_info)
-	prev_info->next = info->next;
-    else
-	ic->private.proto.commit_info = info->next;
+    ic->private.proto.commit_info = info->next;
     Xfree(info);
     return;
 }
 
-static void
-_XimUnregCommitInfo(
-    Xic			ic)
-{
-    _XimUnregRealCommitInfo(ic, False);
-}
-
-static void
-_XimUnregFirstCommitInfo(
-    Xic			ic)
-{
-    _XimUnregRealCommitInfo(ic, True);
-}
-
 void
 _XimFreeCommitInfo(
     Xic			ic)
@@ -690,19 +665,6 @@ _XimFreeCommitInfo(
     return;
 }
 
-static XimCommitInfo
-_XimFirstCommitInfo(
-    Xic			ic)
-{
-    XimCommitInfo info = ic->private.proto.commit_info;
-    while (info) {
-	if (!info->next)
-	    break;
-	info = info->next;
-    }
-    return info;
-}
-
 static Bool
 _XimProcKeySym(
     Xic			  ic,
@@ -1097,7 +1059,7 @@ _XimProtoMbLookupString(
 	state = &tmp_state;
 
     if ((ev->type == KeyPress) && (ev->keycode == 0)) { /* Filter function */
-	if (!(info = _XimFirstCommitInfo(ic))) {
+	if (!(info = ic->private.proto.commit_info)) {
 	    *state = XLookupNone;
 	    return 0;
 	}
@@ -1113,7 +1075,7 @@ _XimProtoMbLookupString(
 	    else
 		*state = XLookupKeySym;
 	}
-	_XimUnregFirstCommitInfo(ic);
+	_XimUnregCommitInfo(ic);
 
     } else  if (ev->type == KeyPress) {
 	ret = _XimLookupMBText(ic, ev, buffer, bytes, keysym, NULL);
@@ -1160,7 +1122,7 @@ _XimProtoWcLookupString(
 	state = &tmp_state;
 
     if (ev->type == KeyPress && ev->keycode == 0) { /* Filter function */
-	if (!(info = _XimFirstCommitInfo(ic))) {
+	if (!(info = ic->private.proto.commit_info)) {
            *state = XLookupNone;
 	    return 0;
 	}
@@ -1176,7 +1138,7 @@ _XimProtoWcLookupString(
 	    else
 		*state = XLookupKeySym;
 	}
-	_XimUnregFirstCommitInfo(ic);
+	_XimUnregCommitInfo(ic);
 
     } else if (ev->type == KeyPress) {
 	ret = _XimLookupWCText(ic, ev, buffer, bytes, keysym, NULL);
@@ -1223,7 +1185,7 @@ _XimProtoUtf8LookupString(
 	state = &tmp_state;
 
     if (ev->type == KeyPress && ev->keycode == 0) { /* Filter function */
-	if (!(info = _XimFirstCommitInfo(ic))) {
+	if (!(info = ic->private.proto.commit_info)) {
            *state = XLookupNone;
 	    return 0;
 	}
@@ -1239,7 +1201,7 @@ _XimProtoUtf8LookupString(
 	    else
 		*state = XLookupKeySym;
 	}
-	_XimUnregFirstCommitInfo(ic);
+	_XimUnregCommitInfo(ic);
 
     } else if (ev->type == KeyPress) {
 	ret = _XimLookupUTF8Text(ic, ev, buffer, bytes, keysym, NULL);
-- 
GitLab


From 57af6a7166d1ec15814edd47c4942c7763727fbf Mon Sep 17 00:00:00 2001
From: Weng Xuetian <wengxt@gmail.com>
Date: Fri, 29 Mar 2024 09:45:24 -0700
Subject: [PATCH 2/2] Revert "ximcp: Unmark to fabricate key events with
 XKeyEvent serial"

This reverts commit 024d229fdf88a7755577b01b46af6ef908d599e0.
---
 modules/im/ximcp/imDefFlt.c  |  8 ++---
 modules/im/ximcp/imDefIm.c   |  1 -
 modules/im/ximcp/imDefLkup.c | 58 ++++--------------------------------
 src/xlibi18n/XimintP.h       | 17 -----------
 4 files changed, 9 insertions(+), 75 deletions(-)

diff --git a/modules/im/ximcp/imDefFlt.c b/modules/im/ximcp/imDefFlt.c
index 834b9db4..44cc6884 100644
--- a/modules/im/ximcp/imDefFlt.c
+++ b/modules/im/ximcp/imDefFlt.c
@@ -142,9 +142,9 @@ _XimProtoKeypressFilter(
 {
     Xim		im = (Xim)ic->core.im;
 
-    if (_XimIsFabricatedSerial(im, ev->serial)) {
+    if (IS_FABRICATED(im)) {
 	_XimPendingFilter(ic);
-	_XimUnfabricateSerial(im, ev->serial);
+	UNMARK_FABRICATED(im);
 	return NOTFILTERD;
     }
 
@@ -203,9 +203,9 @@ _XimProtoKeyreleaseFilter(
 {
     Xim		im = (Xim)ic->core.im;
 
-    if (_XimIsFabricatedSerial(im, ev->serial)) {
+    if (IS_FABRICATED(im)) {
 	_XimPendingFilter(ic);
-	_XimUnfabricateSerial(im, ev->serial);
+	UNMARK_FABRICATED(im);
 	return NOTFILTERD;
     }
 
diff --git a/modules/im/ximcp/imDefIm.c b/modules/im/ximcp/imDefIm.c
index ac7f1195..fe4d18ba 100644
--- a/modules/im/ximcp/imDefIm.c
+++ b/modules/im/ximcp/imDefIm.c
@@ -430,7 +430,6 @@ _XimPreConnect(
 	return False;
 
     im->private.proto.im_window = im_window;
-    im->private.proto.fabricated_serial = 0;
     return True;
 }
 
diff --git a/modules/im/ximcp/imDefLkup.c b/modules/im/ximcp/imDefLkup.c
index 5192e8c1..dd1adf53 100644
--- a/modules/im/ximcp/imDefLkup.c
+++ b/modules/im/ximcp/imDefLkup.c
@@ -341,54 +341,6 @@ _XimForwardEvent(
     return _XimForwardEventCore(ic, ev, sync);
 }
 
-Bool
-_XimFabricateSerial(
-    Xim			 im,
-    unsigned long	 serial)
-{
-    if (!serial)
-	return False;
-    if (serial == im->private.proto.fabricated_serial) {
-	fprintf(stderr, "%s,%d: The key event is already fabricated.\n", __FILE__, __LINE__);
-	return False;
-    }
-    if (im->private.proto.fabricated_serial)
-	fprintf(stderr, "%s,%d: Tried to fabricate a wrong key event.\n", __FILE__, __LINE__);
-
-    MARK_FABRICATED(im);
-    im->private.proto.fabricated_serial = serial;
-    return True;
-}
-
-Bool
-_XimUnfabricateSerial(
-    Xim			 im,
-    unsigned long	 serial)
-{
-    if (!serial)
-	return False;
-    if (!im->private.proto.fabricated_serial) {
-	fprintf(stderr, "%s,%d: The key event is already unfabricated.\n", __FILE__, __LINE__);
-	return False;
-    }
-    if (serial != im->private.proto.fabricated_serial)
-	fprintf(stderr, "%s,%d: Tried to unfabricate a wrong key event.\n", __FILE__, __LINE__);
-
-    im->private.proto.fabricated_serial = 0;
-    UNMARK_FABRICATED(im);
-    return True;
-}
-
-Bool
-_XimIsFabricatedSerial(
-    Xim			 im,
-    unsigned long	 serial)
-{
-    if (!serial)
-	return False;
-    return (serial == im->private.proto.fabricated_serial);
-}
-
 static void
 _XimProcEvent(
     Display		*d,
@@ -403,7 +355,7 @@ _XimProcEvent(
     ev->xany.serial |= serial << 16;
     ev->xany.send_event = False;
     ev->xany.display = d;
-    _XimFabricateSerial((Xim)ic->core.im, ev->xany.serial);
+    MARK_FABRICATED(ic->core.im);
     return;
 }
 
@@ -752,6 +704,10 @@ _XimCommitRecv(
 
     (void)_XimRespSyncReply(ic, flag);
 
+    if (ic->private.proto.registed_filter_event
+	& (KEYPRESS_MASK | KEYRELEASE_MASK))
+	    MARK_FABRICATED(im);
+
     bzero(&ev, sizeof(ev));	/* uninitialized : found when running kterm under valgrind */
 
     ev.type = KeyPress;
@@ -763,10 +719,6 @@ _XimCommitRecv(
 
     ev.time = 0L;
     ev.serial = LastKnownRequestProcessed(im->core.display);
-
-    if (ic->private.proto.registed_filter_event
-	& (KEYPRESS_MASK | KEYRELEASE_MASK))
-	    _XimFabricateSerial(im, ev.serial);
     /* FIXME :
        I wish there were COMMENTs (!) about the data passed around.
     */
diff --git a/src/xlibi18n/XimintP.h b/src/xlibi18n/XimintP.h
index 2a51e2ed..674da029 100644
--- a/src/xlibi18n/XimintP.h
+++ b/src/xlibi18n/XimintP.h
@@ -149,8 +149,6 @@ typedef struct _XimProtoPrivateRec {
     XimTransRegDispatcher	 register_dispatcher;
     XimTransCallDispatcher	 call_dispatcher;
     XPointer			 spec;
-
-    unsigned long                fabricated_serial;
 } XimProtoPrivateRec;
 
 /*
@@ -309,19 +307,4 @@ typedef struct _XicProtoPrivateRec {
 #define XIM_MAXIMNAMELEN 64
 #define XIM_MAXLCNAMELEN 64
 
-Bool
-_XimFabricateSerial(
-    Xim                  im,
-    unsigned long        serial);
-
-Bool
-_XimUnfabricateSerial(
-    Xim                  im,
-    unsigned long        serial);
-
-Bool
-_XimIsFabricatedSerial(
-    Xim                  im,
-    unsigned long        serial);
-
 #endif /* _XIMINTP_H */
-- 
GitLab

