From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Reilly Brogan <reilly@reillybrogan.com>
Date: Fri, 14 Jun 2024 00:09:19 -0500
Subject: [PATCH] Use system libs

This patch is likely to break on zed version updates. To update this patch do the following:
1. `git am` the patch file or `git cherry-pick` if you already have it in your git repo
2. Fix the conflicts to `Cargo.toml` files.
3. Just revert `Cargo.lock` to the pre-patch/pre-cherry-pick version: `git checkout --ours Cargo.lock`
4. Run `cargo fetch --offline` to update the lock file but without updating any dependencies
5. Complete the `git am` or cherry-pick and the export the commit as the new patch

Signed-off-by: Reilly Brogan <reilly@reillybrogan.com>
---
 Cargo.lock               | 11 +----------
 Cargo.toml               |  1 -
 crates/client/Cargo.toml |  4 ++--
 crates/rpc/Cargo.toml    |  2 +-
 crates/sqlez/Cargo.toml  |  2 +-
 5 files changed, 5 insertions(+), 15 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index ff4b3f459..7a9dcfc22 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -5927,6 +5927,7 @@ version = "0.26.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "afc22eff61b133b115c6e8c74e818c628d6d5e7a502afea6f64dee076dd94326"
 dependencies = [
+ "bindgen 0.64.0",
  "cc",
  "pkg-config",
  "vcpkg",
@@ -7013,15 +7014,6 @@ version = "0.1.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "ff011a302c396a5197692431fc1948019154afc178baf7d8e37367442a4601cf"
 
-[[package]]
-name = "openssl-src"
-version = "300.2.3+3.2.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "5cff92b6f71555b61bb9315f7c64da3ca43d87531622120fea0195fc761b4843"
-dependencies = [
- "cc",
-]
-
 [[package]]
 name = "openssl-sys"
 version = "0.9.93"
@@ -7030,7 +7022,6 @@ checksum = "db4d56a4c0478783083cfafcc42493dd4a981d41669da64b4572a2a089b51b1d"
 dependencies = [
  "cc",
  "libc",
- "openssl-src",
  "pkg-config",
  "vcpkg",
 ]
diff --git a/Cargo.toml b/Cargo.toml
index 72dd44a38..96f82af16 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -296,7 +296,6 @@ ignore = "0.4.22"
 indoc = "1"
 # We explicitly disable http2 support in isahc.
 isahc = { version = "1.7.2", default-features = false, features = [
-    "static-curl",
     "text-decoding",
 ] }
 itertools = "0.11.0"
diff --git a/crates/client/Cargo.toml b/crates/client/Cargo.toml
index b502c2d1e..5531a68da 100644
--- a/crates/client/Cargo.toml
+++ b/crates/client/Cargo.toml
@@ -19,7 +19,7 @@ test-support = ["clock/test-support", "collections/test-support", "gpui/test-sup
 anyhow.workspace = true
 async-recursion = "0.3"
 async-tungstenite = { version = "0.16", features = ["async-std", "async-native-tls"] }
-async-native-tls = { version = "0.5.0", features = ["vendored"] }
+async-native-tls = { version = "0.5.0" }
 chrono = { workspace = true, features = ["serde"] }
 clock.workspace = true
 collections.workspace = true
@@ -61,7 +61,7 @@ util = { workspace = true, features = ["test-support"] }
 http = { workspace = true, features = ["test-support"] }
 
 [target.'cfg(target_os = "linux")'.dependencies]
-async-native-tls = {"version" = "0.5.0", features = ["vendored"]}
+async-native-tls = {"version" = "0.5.0"}
 # This is an indirect dependency of async-tungstenite that is included
 # here so we can vendor libssl with the feature flag.
 [package.metadata.cargo-machete]
diff --git a/crates/rpc/Cargo.toml b/crates/rpc/Cargo.toml
index b197073b7..d77ed09fa 100644
--- a/crates/rpc/Cargo.toml
+++ b/crates/rpc/Cargo.toml
@@ -33,7 +33,7 @@ serde_json.workspace = true
 strum.workspace = true
 tracing = { version = "0.1.34", features = ["log"] }
 util.workspace = true
-zstd = "0.11"
+zstd = { version = "0.11", features = [ "pkg-config" ] }
 
 [build-dependencies]
 prost-build.workspace = true
diff --git a/crates/sqlez/Cargo.toml b/crates/sqlez/Cargo.toml
index 98b05a06e..b97001dd8 100644
--- a/crates/sqlez/Cargo.toml
+++ b/crates/sqlez/Cargo.toml
@@ -14,7 +14,7 @@ collections.workspace = true
 futures.workspace = true
 indoc.workspace = true
 lazy_static.workspace = true
-libsqlite3-sys = { version = "0.26", features = ["bundled"] }
+libsqlite3-sys = { version = "0.26", features = ["buildtime_bindgen"] }
 parking_lot.workspace = true
 smol.workspace = true
 thread_local = "1.1.4"
